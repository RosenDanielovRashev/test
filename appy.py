import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime
import base64
from io import BytesIO
from fpdf import FPDF
import matplotlib.pyplot as plt

st.set_page_config(page_title="–¢–µ—Å—Ç–æ–≤–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å PDF –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ", layout="wide")

st.title("üìä –¢–µ—Å—Ç–æ–≤–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å PDF –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ")
st.markdown("---")

# –°–µ–∫—Ü–∏—è 1: –í—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏
st.header("üìù –í—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏")
col1, col2, col3 = st.columns(3)

with col1:
    –∏–º–µ_–ø—Ä–æ–µ–∫—Ç = st.text_input("–ò–º–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç", "–ú–æ—è—Ç —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç")
    –±—é–¥–∂–µ—Ç = st.number_input("–ë—é–¥–∂–µ—Ç (–ª–≤)", min_value=0, value=10000)

with col2:
    –Ω–∞—á–∞–ª–æ_–¥–∞—Ç–∞ = st.date_input("–ù–∞—á–∞–ª–Ω–∞ –¥–∞—Ç–∞")
    –∫—Ä–∞–π_–¥–∞—Ç–∞ = st.date_input("–ö—Ä–∞–π–Ω–∞ –¥–∞—Ç–∞")

with col3:
    –±—Ä–æ–π_–µ–ª–µ–º–µ–Ω—Ç–∏ = st.slider("–ë—Ä–æ–π –µ–ª–µ–º–µ–Ω—Ç–∏", 1, 100, 10)
    –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç = st.selectbox("–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç", ["–ù–∏—Å—ä–∫", "–°—Ä–µ–¥–µ–Ω", "–í–∏—Å–æ–∫"])

# –ò–∑—á–∏—Å–ª–µ–Ω–∏—è
—Å—Ä–µ–¥–Ω–∞_—Å—Ç–æ–π–Ω–æ—Å—Ç = –±—é–¥–∂–µ—Ç / –±—Ä–æ–π_–µ–ª–µ–º–µ–Ω—Ç–∏ if –±—Ä–æ–π_–µ–ª–µ–º–µ–Ω—Ç–∏ > 0 else 0
–¥–Ω–∏_–ø—Ä–æ–µ–∫—Ç = (–∫—Ä–∞–π_–¥–∞—Ç–∞ - –Ω–∞—á–∞–ª–æ_–¥–∞—Ç–∞).days if –∫—Ä–∞–π_–¥–∞—Ç–∞ and –Ω–∞—á–∞–ª–æ_–¥–∞—Ç–∞ else 0

st.markdown("---")

# –°–µ–∫—Ü–∏—è 2: –ì—Ä–∞—Ñ–∏–∫–∏
st.header("üìà –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏")

# –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –ø—Ä–∏–º–µ—Ä–Ω–∏ –¥–∞–Ω–Ω–∏
–¥–∞–Ω–Ω–∏ = pd.DataFrame({
    '–ú–µ—Å–µ—Ü': ['–Ø–Ω—É', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–Æ–Ω–∏'],
    '–ü—Ä–∏—Ö–æ–¥–∏': np.random.randint(1000, 5000, 6),
    '–†–∞–∑—Ö–æ–¥–∏': np.random.randint(500, 3000, 6)
})
–¥–∞–Ω–Ω–∏['–ü–µ—á–∞–ª–±–∞'] = –¥–∞–Ω–Ω–∏['–ü—Ä–∏—Ö–æ–¥–∏'] - –¥–∞–Ω–Ω–∏['–†–∞–∑—Ö–æ–¥–∏']

col1, col2 = st.columns(2)

with col1:
    st.subheader("–ü—Ä–∏—Ö–æ–¥–∏ –∏ —Ä–∞–∑—Ö–æ–¥–∏")
    fig1 = px.bar(–¥–∞–Ω–Ω–∏, x='–ú–µ—Å–µ—Ü', y=['–ü—Ä–∏—Ö–æ–¥–∏', '–†–∞–∑—Ö–æ–¥–∏'], 
                  title="–ü—Ä–∏—Ö–æ–¥–∏ –∏ —Ä–∞–∑—Ö–æ–¥–∏ –ø–æ –º–µ—Å–µ—Ü–∏",
                  barmode='group')
    st.plotly_chart(fig1, use_container_width=True)

with col2:
    st.subheader("–ü–µ—á–∞–ª–±–∞")
    fig2 = px.line(–¥–∞–Ω–Ω–∏, x='–ú–µ—Å–µ—Ü', y='–ü–µ—á–∞–ª–±–∞', 
                   title="–ü–µ—á–∞–ª–±–∞ –ø–æ –º–µ—Å–µ—Ü–∏", markers=True)
    fig2.add_hline(y=0, line_dash="dash", line_color="red")
    st.plotly_chart(fig2, use_container_width=True)

# –°–µ–∫—Ü–∏—è 3: –¢–∞–±–ª–∏—Ü–∏
st.header("üìã –î–∞–Ω–Ω–∏ –≤ —Ç–∞–±–ª–∏—Ü–∞")
table_data = pd.DataFrame({
    'ID': range(1, 7),
    '–ó–∞–¥–∞—á–∞': [f'–ó–∞–¥–∞—á–∞ {i}' for i in range(1, 7)],
    '–°—Ç–∞—Ç—É—Å': ['–ó–∞–≤—ä—Ä—à–µ–Ω–∞', '–í –ø—Ä–æ–≥—Ä–µ—Å', '–ß–∞–∫–∞—â–∞', '–ó–∞–≤—ä—Ä—à–µ–Ω–∞', '–í –ø—Ä–æ–≥—Ä–µ—Å', '–ß–∞–∫–∞—â–∞'],
    '–ü—Ä–æ–≥—Ä–µ—Å %': [100, 75, 0, 100, 50, 25],
    '–û—Ç–≥–æ–≤–æ—Ä–µ–Ω': ['–ò–≤–∞–Ω', '–ú–∞—Ä–∏—è', '–ü–µ—Ç—ä—Ä', '–ê–Ω–Ω–∞', '–ì–µ–æ—Ä–≥–∏', '–ï–ª–µ–Ω–∞']
})
st.dataframe(table_data, use_container_width=True)

st.markdown("---")

# –§—É–Ω–∫—Ü–∏—è –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF
def generate_pdf():
    pdf = FPDF()
    pdf.add_page()
    
    # –ó–∞–≥–ª–∞–≤–∏–µ
    pdf.set_font('Arial', 'B', 16)
    pdf.cell(200, 10, f'–û–¢–ß–ï–¢: {–∏–º–µ_–ø—Ä–æ–µ–∫—Ç}', 0, 1, 'C')
    pdf.ln(10)
    
    # –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    pdf.set_font('Arial', 'B', 12)
    pdf.cell(200, 10, '–û—Å–Ω–æ–≤–Ω–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏:', 0, 1)
    pdf.set_font('Arial', '', 11)
    
    info_data = [
        f'–ò–º–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç: {–∏–º–µ_–ø—Ä–æ–µ–∫—Ç}',
        f'–ë—é–¥–∂–µ—Ç: {–±—é–¥–∂–µ—Ç} –ª–≤',
        f'–ù–∞—á–∞–ª–Ω–∞ –¥–∞—Ç–∞: {–Ω–∞—á–∞–ª–æ_–¥–∞—Ç–∞}',
        f'–ö—Ä–∞–π–Ω–∞ –¥–∞—Ç–∞: {–∫—Ä–∞–π_–¥–∞—Ç–∞}',
        f'–ë—Ä–æ–π –µ–ª–µ–º–µ–Ω—Ç–∏: {–±—Ä–æ–π_–µ–ª–µ–º–µ–Ω—Ç–∏}',
        f'–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç}',
        f'–°—Ä–µ–¥–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç: {—Å—Ä–µ–¥–Ω–∞_—Å—Ç–æ–π–Ω–æ—Å—Ç:.2f} –ª–≤',
        f'–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç –Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞: {–¥–Ω–∏_–ø—Ä–æ–µ–∫—Ç} –¥–Ω–∏'
    ]
    
    for info in info_data:
        pdf.cell(200, 8, info, 0, 1)
    
    pdf.ln(10)
    
    # –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω–∏
    pdf.set_font('Arial', 'B', 12)
    pdf.cell(200, 10, '–¢–∞–±–ª–∏—Ü–∞ —Å—ä—Å –∑–∞–¥–∞—á–∏:', 0, 1)
    pdf.ln(5)
    
    # –ó–∞–≥–ª–∞–≤–∏—è –Ω–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞
    pdf.set_font('Arial', 'B', 10)
    col_widths = [15, 50, 40, 30, 40]
    headers = ['ID', '–ó–∞–¥–∞—á–∞', '–°—Ç–∞—Ç—É—Å', '–ü—Ä–æ–≥—Ä–µ—Å %', '–û—Ç–≥–æ–≤–æ—Ä–µ–Ω']
    
    for i, header in enumerate(headers):
        pdf.cell(col_widths[i], 10, header, 1, 0, 'C')
    pdf.ln()
    
    # –î–∞–Ω–Ω–∏ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞
    pdf.set_font('Arial', '', 9)
    for index, row in table_data.iterrows():
        pdf.cell(col_widths[0], 10, str(row['ID']), 1, 0, 'C')
        pdf.cell(col_widths[1], 10, str(row['–ó–∞–¥–∞—á–∞']), 1, 0, 'L')
        pdf.cell(col_widths[2], 10, str(row['–°—Ç–∞—Ç—É—Å']), 1, 0, 'C')
        pdf.cell(col_widths[3], 10, str(row['–ü—Ä–æ–≥—Ä–µ—Å %']), 1, 0, 'C')
        pdf.cell(col_widths[4], 10, str(row['–û—Ç–≥–æ–≤–æ—Ä–µ–Ω']), 1, 0, 'C')
        pdf.ln()
    
    pdf.ln(10)
    
    # –§–∏–Ω–∞–Ω—Å–æ–≤–∏ –¥–∞–Ω–Ω–∏
    pdf.set_font('Arial', 'B', 12)
    pdf.cell(200, 10, '–§–∏–Ω–∞–Ω—Å–æ–≤–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:', 0, 1)
    pdf.set_font('Arial', '', 11)
    
    pdf.cell(200, 8, f'–û–±—â –ø—Ä–∏—Ö–æ–¥: {–¥–∞–Ω–Ω–∏["–ü—Ä–∏—Ö–æ–¥–∏"].sum()} –ª–≤', 0, 1)
    pdf.cell(200, 8, f'–û–±—â —Ä–∞–∑—Ö–æ–¥: {–¥–∞–Ω–Ω–∏["–†–∞–∑—Ö–æ–¥–∏"].sum()} –ª–≤', 0, 1)
    pdf.cell(200, 8, f'–û–±—â–∞ –ø–µ—á–∞–ª–±–∞: {–¥–∞–Ω–Ω–∏["–ü–µ—á–∞–ª–±–∞"].sum()} –ª–≤', 0, 1)
    pdf.cell(200, 8, f'–°—Ä–µ–¥–Ω–∞ –º–µ—Å–µ—á–Ω–∞ –ø–µ—á–∞–ª–±–∞: {–¥–∞–Ω–Ω–∏["–ü–µ—á–∞–ª–±–∞"].mean():.2f} –ª–≤', 0, 1)
    
    pdf.ln(10)
    
    # –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
    pdf.set_font('Arial', 'I', 10)
    pdf.cell(200, 8, f'–û—Ç—á–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω –Ω–∞: {datetime.now().strftime("%Y-%m-%d %H:%M")}', 0, 1)
    pdf.cell(200, 8, '–¢–æ–≤–∞ –µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω –æ—Ç—á–µ—Ç –æ—Ç —Ç–µ—Å—Ç–æ–≤–æ—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.', 0, 1)
    
    return pdf

# –°–µ–∫—Ü–∏—è –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF
st.header("üìÑ –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF –æ—Ç—á–µ—Ç")

st.markdown("""
### –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:
- –ü–æ–ø—ä–ª–Ω–µ—Ç–µ –¥–∞–Ω–Ω–∏—Ç–µ –ø–æ-–≥–æ—Ä–µ
- –ö–ª–∏–∫–Ω–µ—Ç–µ –±—É—Ç–æ–Ω–∞ –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF
- PDF —Ñ–∞–π–ª—ä—Ç —â–µ —Å–µ –∏–∑—Ç–µ–≥–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
""")

if st.button("üîÑ –ì–µ–Ω–µ—Ä–∏—Ä–∞–π PDF –æ—Ç—á–µ—Ç", type="primary"):
    try:
        # –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF
        pdf = generate_pdf()
        
        # –ó–∞–ø–∞–∑–≤–∞–Ω–µ –≤ –ø–∞–º–µ—Ç—Ç–∞
        pdf_output = pdf.output(dest='S').encode('latin1')
        
        # –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ download –±—É—Ç–æ–Ω
        st.download_button(
            label="üì• –ò–∑—Ç–µ–≥–ª–∏ PDF —Ñ–∞–π–ª",
            data=pdf_output,
            file_name=f"–æ—Ç—á–µ—Ç_{–∏–º–µ_–ø—Ä–æ–µ–∫—Ç}_{datetime.now().strftime('%Y%m%d_%H%M')}.pdf",
            mime="application/pdf",
            type="primary"
        )
        
        st.success("‚úÖ PDF –æ—Ç—á–µ—Ç—ä—Ç –µ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ! –ö–ª–∏–∫–Ω–µ—Ç–µ –±—É—Ç–æ–Ω–∞ –∑–∞ –∏–∑—Ç–µ–≥–ª—è–Ω–µ.")
        
    except Exception as e:
        st.error(f"‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF: {str(e)}")

# –î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
st.markdown("---")
st.info("""
**–ó–∞–±–µ–ª–µ–∂–∫–∞:** –¢–æ–∑–∏ PDF —Å—ä–¥—ä—Ä–∂–∞ –≤—Å–∏—á–∫–∏ –≤—ä–≤–µ–¥–µ–Ω–∏ –¥–∞–Ω–Ω–∏, —Ç–∞–±–ª–∏—Ü–∏ –∏ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è, 
–Ω–æ –Ω–µ –≤–∫–ª—é—á–≤–∞ –≥—Ä–∞—Ñ–∏–∫–∏—Ç–µ. –ó–∞ –≤–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∏ –≤ PDF —â–µ —Å–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏ 
–¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∫–∞—Ç–æ `imgkit` –∏–ª–∏ `weasyprint`.
""")
